/*
Deployment script for book_shop

This code was generated by a tool.
Changes to this file may cause incorrect behavior and will be lost if
the code is regenerated.
*/

GO
SET ANSI_NULLS, ANSI_PADDING, ANSI_WARNINGS, ARITHABORT, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER ON;

SET NUMERIC_ROUNDABORT OFF;


GO
:setvar DatabaseName "book_shop"
:setvar DefaultFilePrefix "book_shop"
:setvar DefaultDataPath "C:\Program Files\Microsoft SQL Server\MSSQL16.LOCAL2022\MSSQL\DATA\"
:setvar DefaultLogPath "C:\Program Files\Microsoft SQL Server\MSSQL16.LOCAL2022\MSSQL\DATA\"

GO
:on error exit
GO
/*
Detect SQLCMD mode and disable script execution if SQLCMD mode is not supported.
To re-enable the script after enabling SQLCMD mode, execute the following:
SET NOEXEC OFF; 
*/
:setvar __IsSqlCmdEnabled "True"
GO
IF N'$(__IsSqlCmdEnabled)' NOT LIKE N'True'
    BEGIN
        PRINT N'SQLCMD mode must be enabled to successfully execute this script.';
        SET NOEXEC ON;
    END


GO
USE [$(DatabaseName)];


GO
PRINT N'Creating Table [dbo].[author]...';


GO
CREATE TABLE [dbo].[author] (
    [author_id]  INT           IDENTITY (1, 1) NOT NULL,
    [first_name] NVARCHAR (30) NULL,
    [last_name]  NVARCHAR (30) NULL,
    CONSTRAINT [pk_author] PRIMARY KEY CLUSTERED ([author_id] ASC)
);


GO
PRINT N'Creating Table [dbo].[availability]...';


GO
CREATE TABLE [dbo].[availability] (
    [availability_id]   INT           IDENTITY (1, 1) NOT NULL,
    [availability_code] INT           NOT NULL,
    [availability_desc] NVARCHAR (20) NULL,
    CONSTRAINT [pk_availability] PRIMARY KEY CLUSTERED ([availability_id] ASC)
);


GO
PRINT N'Creating Table [dbo].[books]...';


GO
CREATE TABLE [dbo].[books] (
    [book_id]         BIGINT          IDENTITY (1, 1) NOT NULL,
    [title]           NVARCHAR (300)  NOT NULL,
    [ISBN]            NVARCHAR (13)   NOT NULL,
    [Description]     NVARCHAR (MAX)  NULL,
    [pricing]         DECIMAL (10, 2) NULL,
    [quantity]        SMALLINT        NULL,
    [availability_id] INT             NOT NULL,
    [category_id]     INT             NOT NULL,
    [author_id]       INT             NULL,
    [release_date]    DATE            NULL,
    CONSTRAINT [pk_books] PRIMARY KEY CLUSTERED ([book_id] ASC)
);


GO
PRINT N'Creating Index [dbo].[books].[UQ_ISBN]...';


GO
CREATE UNIQUE NONCLUSTERED INDEX [UQ_ISBN]
    ON [dbo].[books]([ISBN] ASC);


GO
PRINT N'Creating Table [dbo].[category]...';


GO
CREATE TABLE [dbo].[category] (
    [category_id]   INT            IDENTITY (1, 1) NOT NULL,
    [category_code] NVARCHAR (6)   NOT NULL,
    [category_desc] NVARCHAR (100) NOT NULL,
    CONSTRAINT [pk_category] PRIMARY KEY CLUSTERED ([category_id] ASC)
);


GO
PRINT N'Creating Foreign Key [dbo].[fk_category_id]...';


GO
ALTER TABLE [dbo].[books] WITH NOCHECK
    ADD CONSTRAINT [fk_category_id] FOREIGN KEY ([category_id]) REFERENCES [dbo].[category] ([category_id]);


GO
PRINT N'Creating Foreign Key [dbo].[fk_author_id]...';


GO
ALTER TABLE [dbo].[books] WITH NOCHECK
    ADD CONSTRAINT [fk_author_id] FOREIGN KEY ([author_id]) REFERENCES [dbo].[author] ([author_id]);


GO
PRINT N'Creating Foreign Key [dbo].[fk_availability]...';


GO
ALTER TABLE [dbo].[books] WITH NOCHECK
    ADD CONSTRAINT [fk_availability] FOREIGN KEY ([availability_id]) REFERENCES [dbo].[availability] ([availability_id]);


GO
PRINT N'Checking existing data against newly created constraints';


GO
USE [$(DatabaseName)];


GO
ALTER TABLE [dbo].[books] WITH CHECK CHECK CONSTRAINT [fk_category_id];

ALTER TABLE [dbo].[books] WITH CHECK CHECK CONSTRAINT [fk_author_id];

ALTER TABLE [dbo].[books] WITH CHECK CHECK CONSTRAINT [fk_availability];


GO
PRINT N'Update complete.';


GO
